{"id":8306,"name":"HubSpotConnect","userId":197288,"accountId":176546,"createdDate":"2019-09-17T10:35:55Z","steps":[{"id":84511,"onSuccess":["UpdateChargebeeConfig"],"onFailure":[],"name":"Updateconfig","type":"script","properties":{"body":"let chargebeeInstanceId = 0;\n\nif(steps.chargebeeInstanceFound !== undefined) {\n  chargebeeInstanceId = steps.chargebeeInstanceFound.id;\n}\n\nif(steps.chargebeeInstanceCreated !== undefined) {\n  chargebeeInstanceId = steps.chargebeeInstanceCreated.id;\n}\n\n\n\nlet param = steps.InputParams;\nparam.body.config_json.cloudElements.chargebee =  {\n  element: param.input.chargebeeElement,\n      instance: chargebeeInstanceId\n};\ndone(param);\n"}},{"id":84510,"onSuccess":["Success"],"onFailure":[],"name":"UpdateChargebeeConfig","type":"httpRequest","properties":{"headers":"${steps.Updateconfig.headers}","url":"${steps.Updateconfig.url}","method":"POST","body":"${steps.Updateconfig.body}"}},{"id":84509,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"let connectCard = {\n\t\"contents\":[\n\t\t\"HubSpot is a CRM that helps analyze business metrics and organize sales pipelines. With HubSpot, you can convert leads into paying customers, run marketing campaigns, automate emails, track the progress of your leads, and more.\",\n\t\t\"Integrate HubSpot with Chargebee to sync customer and subscription data, orders, invoices, and more. With this integration, you can create deals for subscriptions, manage customer-related data, keep a track on the performance of your sales team, and so on. <a href='https://www.chargebee.com/docs/hubspot.html' target='blank'>Learn more</a>\"\n\t],\n\t\"docUrl\":\"https://www.hubspot.com/\",\n\t\"signupUrl\":\"https://www.hubspot.com/\",\n\t\"requestType\": \"oauthredirect\",\n\t\"connect\":{\n\t\t\"id\":\"credentials\",\n\t\t\"display\" : \"Connect\",\n\t\t\"icon\" : \"ARROW\",\n\t\t\"buttonLook\":\"FILLED\",\n\t\t\"type\" : \"DIRECT_LINK\",\n\t\t\"redirectUrl\" : \"https://app.hubspot.com/oauth/authorize?client_id=\"+steps.InputParams.input.clientId+\"&scope=\"+steps.InputParams.input.scope+\"&state=\"+steps.InputParams.input.siteName+\"&redirect_uri=\"+steps.InputParams.input.redirectUrl,\n\t\t\"request\":{\n      \"type\":\"ON_CLICK_DEFAULT_ACTION\"\n    }\n\t},\n\t\"message\":{\n\t\t\t      \"message\":\"Chargebee will sync your customer and subscriptions detaiils with HubSpot.\",\n\t\t\t      \"icon\":\"INFO\",\n\t\t\t      \"messageLook\":\"INFO\",\n\t\t\t      \"boxNeeded\":\"false\",\n\t\t\t \"button\": {\n\t\t\t    \"display\": \"Read Privacy Policy\",\n\t\t\t    \"icon\": \"OPENINNEW\",\n\t\t\t    \"url\":\"https://legal.hubspot.com/privacy-policy\",\n\t\t\t    \"id\": \"readprivacy\",\n\t\t\t    \"type\": \"DIRECT_LINK\",\n\t\t            \"newTab\":\"true\"       \n\t\t\t  }\n\t}\n};\n\ndone({\n  statusCode: 200,\n  result: connectCard\n});"}},{"id":84508,"onSuccess":["sendErrorCard"],"onFailure":[],"name":"sendErrorMail","type":"httpRequest","properties":{"headers":"${steps.InputParams.sendErrorMailParams.headers}","retryDelay":"200","retryAttempts":"5","retry":"true","url":"${steps.InputParams.sendErrorMailParams.url}","method":"POST","query":"${steps.InputParams.sendErrorMailParams.query}"}},{"id":84507,"onSuccess":[],"onFailure":[],"name":"sendErrorCard","type":"script","properties":{"body":"let card = {\n    \"cards\": [{\n        \"id\": \"check2\",\n        \"card\": {\n            \"type\": \"ACTION\",\n            \"heading\": \"Integration Error:  Initialization Failed\",\n            \"listContent\": [\n                \"Integration Error:  Initialization Failed, \"+steps.InputParams.error\n            ],\n            \"icon\": \"WARNING\"\n          \n        }\n    }]\n}\n//let\ndone({\n  statusCode: 200,\n  result: card\n})"}},{"id":84506,"onSuccess":["getChargebeeInstance"],"onFailure":["sendErrorMail"],"name":"noError","type":"filter","properties":{"body":"if(steps.InputParams.apiKey === null){\n  done(false);\n}\n\ndone(true);"}},{"id":84505,"onSuccess":["noError"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'];\nlet siteName = trigger.args.request.query['cb-site-name'];\nlet integrationName = trigger.args.request.query.type;\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet chargebeeElement = trigger.args.request.query.chargebeeElement;\nlet thirdPartyElement = trigger.args.request.query.thirdPartyElement;\n\nlet clientInfo = JSON.parse(trigger.args.request.query.client_info);\n\nlet clientId = clientInfo.client_id;\nlet clientSecret = clientInfo.client_secret;\nlet redirectUrl = clientInfo.redirect_url;\nlet scope = clientInfo.scope;\n\nlet instanceName = siteName+ siteDomain + \"-chargebee\";\n\nlet params = {\n    input: {\n        apiKey: apiKey,\n        siteName: siteName,\n        siteDomain: siteDomain,\n        type: integrationName,\n        chargebeeElement: chargebeeElement,\n        thirdPartyElement: thirdPartyElement,\n        clientId: clientId,\n        clientSecret: clientSecret,\n        redirectUrl: redirectUrl,\n        scope: scope\n    },\n    url: \"https://\" + siteName + \".integrations.\" + siteDomain + \"/integrations/update_tp_integ_conf\",\n    headers: {\n        \"Content-Type\": \"application/json\",\n        \"cache-control\": \"no-cache\"\n    },\n    body: {\n        site_name: siteName,\n        api_key: apiKey,\n        integration_name: integrationName,\n        config_json: {\n            cloudElements: {\n                setup: {\n                    chargebeeElement: chargebeeElement,\n                    thirdPartyElement: thirdPartyElement,\n                    clientId: clientId,\n                    clientSecret: clientSecret,\n                    redirectUrl: redirectUrl,\n                    scope: scope\n                }\n            },\n            new_sub_step : \"connect\"\n        }\n    },\n    chargebee: {\n        elementId: chargebeeElement,\n        searchParam: {\n            searchText: instanceName,\n            'tags[]': instanceName,\n            hydrate: false,\n            pageSize: 1\n        },\n        body: {\n            name: instanceName,\n            configuration: {\n                username: apiKey,\n                site: siteName+\".\"+siteDomain,\n                password: \"\"\n            },\n            tags: [instanceName, siteName]\n        }\n    }\n};\ndone(params);"}},{"id":84504,"onSuccess":["chargebeeInstanceFound"],"onFailure":["createChargebeeInstanceParams"],"name":"getChargebeeInstance","type":"request","properties":{"method":"GET","api":"/instances","query":"${steps.InputParams.chargebee.searchParam}"}},{"id":84503,"onSuccess":["createChargebeeInstance"],"onFailure":[],"name":"createChargebeeInstanceParams","type":"script","properties":{"body":"let chargebeeElementId = steps.InputParams.chargebee.elementId;\n\nlet createChargebeeInstanceConfig = {\n  url: \"/elements/\"+chargebeeElementId+\"/instances\",\n  body: steps.InputParams.chargebee.body\n};\n\n\ndone({\n  createChargebeeInstanceConfig: createChargebeeInstanceConfig\n});"}},{"id":84502,"onSuccess":["chargebeeInstanceCreated"],"onFailure":[],"name":"createChargebeeInstance","type":"request","properties":{"method":"POST","api":"${steps.createChargebeeInstanceParams.createChargebeeInstanceConfig.url}","body":"${steps.createChargebeeInstanceParams.createChargebeeInstanceConfig.body}"}},{"id":84501,"onSuccess":["Updateconfig"],"onFailure":[],"name":"chargebeeInstanceFound","type":"script","properties":{"body":"done({\"id\":steps.getChargebeeInstance.response.body[0].id});"}},{"id":84500,"onSuccess":["Updateconfig"],"onFailure":[],"name":"chargebeeInstanceCreated","type":"script","properties":{"body":"done({\"id\":steps.createChargebeeInstance.response.body.id});"}}],"triggers":[{"id":7259,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/hubspot/connect","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /hubspot/connect","configuration":[]}